import { useEffect, useState } from "react";
import { loadData } from "./services/native";
import { indexBomByParent, explodeBom } from "./domain/bomExplode";
import { computeMaxBuildable } from "./domain/limitingReagent";
import type { DataSnapshot, SKU } from "./domain/types";

const DATA_DIR = "/home/johed/Documents/CsvFiles/Forgeable/data"; // your dev path

export default function App() {
  console.log("ğŸš€ App component rendered - SIMPLE TEST");

  // Temporarily comment out complex logic to test basic React rendering
  /*
  useEffect(() => {
    console.log("ğŸ”„ useEffect triggered, starting data load...");
    setLog("App loaded! Starting to load data...");
    (async () => {
      try {
        console.log("ğŸ“‚ Attempting to load data from:", DATA_DIR);
        setLog("Connecting to native backend...");
        
        const ds = await loadData(DATA_DIR);
        console.log("âœ… Data loaded successfully:", ds);
        setSnap(ds);
        setIsError(false);
        setLog("Data loaded! Processing...");

        const bomByParent = indexBomByParent(ds.bom_items);
        const isAssembly = (sku: SKU) =>
          ds.assemblies.some((a) => a.assemblySku === sku);

        // pick a panel to test
        const panelSku: SKU = "TS2_TYPE01";

        const req1 = explodeBom(panelSku, bomByParent, isAssembly, {
          includeScrap: true,
          minYield: 0.01,
        });

        const buildability = computeMaxBuildable(req1, ds.stock, true);

        const message =
          `Loaded ${ds.assemblies.length} panels, ${ds.parts.length} parts.\n` +
          `Panel tested: ${panelSku}\n` +
          `Requirements per unit: ${JSON.stringify(req1, null, 2)}\n` +
          `Max buildable: ${buildability.maxBuildable}\n` +
          `Limiting: ${buildability.limitingComponents
            .map((l) => l.sku)
            .join(", ")}`;

        console.log(message);
        setLog(message);
      } catch (e: any) {
        console.error("Error loading data:", e);
        setIsError(true);
        setLog(
          `Error: ${String(
            e
          )}\n\nExpected data directory: ${DATA_DIR}\n\nThis error suggests either:\n1. The data directory doesn't exist\n2. The CSV files are missing\n3. The Tauri command isn't properly registered`
        );
      }
    })();
  }, []);
  */

  return (
    <div style={{ padding: 16, fontFamily: "Inter, system-ui, sans-serif" }}>
      <h1>ğŸ”§ Forgeable â€” Dev Check</h1>
      <div style={{ background: "#f0f8ff", padding: 16, borderRadius: 4, marginBottom: 16 }}>
        <h3 style={{ margin: 0, marginBottom: 8, color: "#0066cc" }}>Status</h3>
        <p style={{ margin: 0 }}>React App: âœ… Running</p>
        <p style={{ margin: 0 }}>Data Path: {DATA_DIR}</p>
      </div>
      {isError && (
        <div
          style={{
            background: "#fee",
            border: "1px solid #fcc",
            padding: 16,
            borderRadius: 4,
            marginBottom: 16,
          }}
        >
          <h3 style={{ margin: 0, marginBottom: 8, color: "#c33" }}>
            Error Loading Data
          </h3>
        </div>
      )}
      <pre style={{ whiteSpace: "pre-wrap", fontSize: 12, background: "#f5f5f5", padding: 16, borderRadius: 4 }}>{log}</pre>
      <p style={{ opacity: 0.7 }}>
        If you see â€œLoaded â€¦ panels, â€¦ partsâ€ and â€œMax buildable â€¦â€, the core
        path works.
      </p>
    </div>
  );
}
